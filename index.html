<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beple Labz 2D Arena MVP</title>
<style>
  body { margin:0; font-family:sans-serif; background:#111; color:#fff; }
  #loginDiv, #lobbyDiv, #arenaDiv { display:none; padding:20px; }
  button { padding:10px; margin:5px; cursor:pointer; background:#00ff99; border:none; border-radius:5px; color:#111; font-weight:bold; }
  input { padding:8px; margin:5px; border-radius:5px; border:none; }
  canvas { background:#222; display:block; margin:0 auto; }
  #leaderboard { margin-top:10px; }
</style>
</head>
<body>

<h1 style="text-align:center;">Beple Labz Arena MVP</h1>

<div id="loginDiv">
  <button id="loginBtn">Login with Google</button>
</div>

<div id="lobbyDiv">
  <p>Your Player Code: <span id="playerCode"></span></p>
  <input type="text" id="opponentCode" placeholder="Enter opponent code">
  <button id="connectBtn">Connect</button>
  <h3>Leaderboard</h3>
  <div id="leaderboard"></div>
</div>

<div id="arenaDiv">
  <p>Match against: <span id="opponentName"></span></p>
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <p>Your Health: <span id="playerHealth">100</span> | Opponent Health: <span id="opponentHealth">100</span></p>
  <p>Fake SOL: <span id="playerSOL">100</span></p>
  <button id="exitBtn">Exit Arena</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// TODO: replace with your Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let user, playerCode, matchDoc, opponentUID;
let playerState = {x:50, y:50, health:100, bullets:[], sol:100};
let opponentState = {x:550, y:50, health:100, bullets:[]};
let keys = {w:false,a:false,s:false,d:false,space:false};
let canvas, ctx, gameInterval;

// Utility: generate code
function generateCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = 'BP-';
  for(let i=0;i<5;i++){ code += chars.charAt(Math.floor(Math.random()*chars.length)); }
  return code;
}

// Update leaderboard
function updateLeaderboard() {
  const q = query(collection(db,'users'), orderBy('sol','desc'), limit(5));
  onSnapshot(q,snap=>{
    let html = '';
    snap.forEach(doc=>{
      html += `<p>${doc.data().displayName}: ${doc.data().sol} SOL</p>`;
    });
    document.getElementById('leaderboard').innerHTML = html;
  });
}

// Draw arena
function drawArena() {
  ctx.fillStyle="#222"; ctx.fillRect(0,0,canvas.width,canvas.height);
  // Draw players
  ctx.fillStyle="#00ff99"; ctx.fillRect(playerState.x, playerState.y,20,20);
  ctx.fillStyle="#ff0055"; ctx.fillRect(opponentState.x, opponentState.y,20,20);
  // Draw bullets
  ctx.fillStyle="#ffff00";
  playerState.bullets.forEach(b=>ctx.fillRect(b.x,b.y,5,5));
  opponentState.bullets.forEach(b=>ctx.fillRect(b.x,b.y,5,5));
}

// Game loop
function gameLoop() {
  // Move player
  if(keys.w) playerState.y-=3;
  if(keys.s) playerState.y+=3;
  if(keys.a) playerState.x-=3;
  if(keys.d) playerState.x+=3;

  // Keep in bounds
  playerState.x = Math.max(0,Math.min(canvas.width-20,playerState.x));
  playerState.y = Math.max(0,Math.min(canvas.height-20,playerState.y));

  // Move bullets
  playerState.bullets.forEach(b=>b.x+=b.dir*5);
  opponentState.bullets.forEach(b=>b.x+=b.dir*5);

  // Check collisions
  playerState.bullets.forEach((b,i)=>{
    if(b.x<opponentState.x+20 && b.x>b.x && b.y<opponentState.y+20 && b.y>b.y){
      opponentState.health -=10;
      playerState.bullets.splice(i,1);
    }
  });

  opponentState.bullets.forEach((b,i)=>{
    if(b.x<playerState.x+20 && b.x>b.x && b.y<playerState.y+20 && b.y>b.y){
      playerState.health -=10;
      opponentState.bullets.splice(i,1);
    }
  });

  drawArena();

  // Update health display
  document.getElementById('playerHealth').innerText = playerState.health;
  document.getElementById('opponentHealth').innerText = opponentState.health;

  // Update Firebase
  if(matchDoc){
    updateDoc(matchDoc,{
      playerState,
      opponentState
    });
  }

  // Check end
  if(playerState.health<=0 || opponentState.health<=0){
    clearInterval(gameInterval);
    alert((playerState.health>0?'You win!':'You lose!') + ' Fake SOL updated.');
    // Update fake SOL
    if(playerState.health>0){
      playerState.sol +=10;
    } else {
      playerState.sol -=10;
    }
    updateDoc(doc(db,'users',user.uid),{sol:playerState.sol});
    document.getElementById('playerSOL').innerText = playerState.sol;
  }
}

// Event listeners
document.addEventListener('keydown',e=>{
  if(e.key==='w') keys.w=true;
  if(e.key==='a') keys.a=true;
  if(e.key==='s') keys.s=true;
  if(e.key==='d') keys.d=true;
  if(e.key===' ') keys.space=true;
});
document.addEventListener('keyup',e=>{
  if(e.key==='w') keys.w=false;
  if(e.key==='a') keys.a=false;
  if(e.key==='s') keys.s=false;
  if(e.key==='d') keys.d=false;
  if(e.key===' ') keys.space=false;
});

// Buttons
document.getElementById('loginBtn').addEventListener('click',async()=>{
  const provider = new GoogleAuthProvider();
  const res = await signInWithPopup(auth,provider);
  user = res.user;
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('lobbyDiv').style.display='block';
  playerCode = generateCode();
  document.getElementById('playerCode').innerText = playerCode;
  // save to db
  await setDoc(doc(db,'users',user.uid),{
    displayName:user.displayName,
    sol:playerState.sol,
    playerCode
  });
  updateLeaderboard();
});

document.getElementById('connectBtn').addEventListener('click',async()=>{
  const oppCode = document.getElementById('opponentCode').value.trim();
  const q = query(collection(db,'users'));
  let oppDoc = null;
  const snap = await getDoc(doc(db,'users',oppCode)); // simplified for demo
  opponentUID = snap.exists()?snap.id:null;
  if(!opponentUID){ alert('Opponent not found!'); return; }
  // create match doc
  matchDoc = doc(db,'matches',user.uid+'_'+opponentUID);
  await setDoc(matchDoc,{
    player1:user.uid,
    player2:opponentUID,
    status:'active',
    playerState,
    opponentState,
    stake:10
  });
  document.getElementById('lobbyDiv').style.display='none';
  document.getElementById('arenaDiv').style.display='block';
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');
  gameInterval = setInterval(gameLoop,100);
  document.getElementById('opponentName').innerText = snap.data().displayName;
  document.getElementById('playerSOL').innerText = playerState.sol;
});

document.getElementById('exitBtn').addEventListener('click',()=>{
  clearInterval(gameInterval);
  document.getElementById('arenaDiv').style.display='none';
  document.getElementById('lobbyDiv').style.display='block';
});

</script>
</body>
</html>