<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sipps - Support Creators</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
<style>
body { font-family:'Segoe UI', sans-serif; background:#fff7ed; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
.box { background:white; padding:2rem; border-radius:16px; width:360px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.1); transition:0.3s; }
.box h2 { margin-bottom:1rem; color:#333; }
input, button { width:100%; padding:.7rem; margin:.5rem 0; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
input:focus { outline:none; border-color:#ff6b6b; }
button { background:#ff6b6b; color:white; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { background:#ff3b3b; }
button:disabled { background:#ccc; cursor:not-allowed; }
a { color:#ff6b6b; text-decoration:none; word-break:break-all; }
.wallet { font-size:0.9rem; color:#555; margin-bottom:0.5rem; word-break:break-all; }
.success { color:green; font-size:0.9rem; margin-top:0.5rem; }
</style>
</head>
<body>

<div class="box" id="app">Loading...</div>

<script>
const app = document.getElementById("app");
const PLATFORM_WALLET = "YOUR_PLATFORM_WALLET_PUBLIC_KEY_HERE"; // Replace with your mainnet wallet
const PLATFORM_FEE_SOL = 0.0003; // platform fee ~ $0.1
let wallet = null;
const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"), "confirmed");

// ----- Multi-Wallet Connect -----
async function connectWallet() {
  try {
    if(window.solana?.isPhantom) { wallet = (await window.solana.connect()).publicKey; return wallet; }
    if(window.solflare?.isSolflare) { wallet = (await window.solflare.connect()).publicKey; return wallet; }
    if(window.glow?.isGlow) { wallet = (await window.glow.connect()).publicKey; return wallet; }
    if(window.slope?.isSlope) { wallet = (await window.slope.connect()).publicKey; return wallet; }
    if(window.sollet?.isSollet) { wallet = (await window.sollet.connect()).publicKey; return wallet; }
    alert("No supported wallet found! Install Phantom, Solflare, Glow, Slope, or Sollet.");
  } catch(err) {
    console.error(err);
    alert("Wallet connection failed.");
  }
}

// ----- Send Transaction Multi-Wallet -----
async function sendTransaction(tx) {
  try {
    if(window.solana?.isPhantom) return await window.solana.signAndSendTransaction(tx);
    if(window.solflare?.isSolflare) return await window.solflare.signAndSendTransaction(tx);
    if(window.glow?.isGlow) return await window.glow.signAndSendTransaction(tx);
    if(window.slope?.isSlope) return await window.slope.signAndSendTransaction(tx);
    if(window.sollet?.isSollet) {
      await window.sollet.signTransaction(tx);
      return await window.sollet.sendTransaction(tx, connection);
    }
  } catch(err) {
    console.error(err);
    alert("Transaction failed!");
  }
}

// ----- URL Params -----
function getParams() {
  const url = new URL(window.location.href);
  const params = url.hash.substring(1);
  const data = {};
  params.split("&").forEach(p=>{
    const [k,v] = p.split("=");
    if(k && v) data[k] = decodeURIComponent(v);
  });
  return data;
}

// ----- Creator Page -----
function creatorPage() {
  app.innerHTML = `
    <h2>Create Sipps Profile</h2>
    <div class="wallet" id="walletDisplay">Wallet: Not connected</div>
    <input id="name" placeholder="Display Name (e.g. Jane)" />
    <input id="price" placeholder="Coffee price (SOL)" />
    <button id="connect">Connect Wallet</button>
    <button id="create" disabled>Create Profile</button>
    <p id="link"></p>
  `;

  const connectBtn = document.getElementById("connect");
  const createBtn = document.getElementById("create");
  const linkEl = document.getElementById("link");
  const walletDisplay = document.getElementById("walletDisplay");

  connectBtn.onclick = async () => {
    await connectWallet();
    if(wallet) {
      createBtn.disabled = false;
      connectBtn.textContent = "Wallet Connected ✅";
      walletDisplay.textContent = "Wallet: " + wallet.toString();
    }
  };

  createBtn.onclick = () => {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    if(!name || !price) return alert("Fill all fields");

    const link = `${window.location.origin}/#to=${wallet.toString()}&name=${encodeURIComponent(name)}&price=${price}`;
    linkEl.innerHTML = `Share your link:<br><a href="${link}" target="_blank">${link}</a>`;
    navigator.clipboard.writeText(link).then(()=>{ 
      const success = document.createElement("div");
      success.className = "success";
      success.textContent = "Link copied to clipboard!";
      linkEl.appendChild(success);
    });
    alert("Profile created! Link copied, share anywhere.");
  };
}

// ----- Supporter Page -----
async function supporterPage(params) {
  app.innerHTML = `
    <h2>Support ${params.name || "Creator"}</h2>
    <p>Price: ${params.price} SOL</p>
    <div class="wallet" id="walletDisplay">Wallet: Not connected</div>
    <button id="pay">Buy Coffee ☕</button>
  `;

  const walletDisplay = document.getElementById("walletDisplay");
  document.getElementById("pay").onclick = async () => {
    await connectWallet();
    if(!wallet) return;
    walletDisplay.textContent = "Wallet: " + wallet.toString();

    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet,
        toPubkey: new solanaWeb3.PublicKey(params.to),
        lamports: parseFloat(params.price) * solanaWeb3.LAMPORTS_PER_SOL
      }),
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet,
        toPubkey: new solanaWeb3.PublicKey(PLATFORM_WALLET),
        lamports: PLATFORM_FEE_SOL * solanaWeb3.LAMPORTS_PER_SOL
      })
    );

    const result = await sendTransaction(tx);
    if(result?.signature) {
      alert("☕ Payment sent! Tx: " + result.signature);
    }
  };
}

// ----- Router -----
const params = getParams();
if(params.to) supporterPage(params);
else creatorPage();

</script>
</body>
</html>