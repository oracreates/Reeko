<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sipps - Support Creators</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
<style>
body { font-family:'Segoe UI', sans-serif; background:#fff7ed; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
.box { background:white; padding:2rem; border-radius:16px; width:360px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.1); transition:0.3s; }
.box h2 { margin-bottom:1rem; color:#333; }
input, button { width:100%; padding:.7rem; margin:.5rem 0; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
input:focus { outline:none; border-color:#ff6b6b; }
button { background:#ff6b6b; color:white; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { background:#ff3b3b; }
button:disabled { background:#ccc; cursor:not-allowed; }
a { color:#ff6b6b; text-decoration:none; word-break:break-all; }
</style>
</head>
<body>

<div class="box" id="app">Loading...</div>

<script>
const app = document.getElementById("app");
const PLATFORM_WALLET = "YOUR_PLATFORM_WALLET_PUBLIC_KEY_HERE"; // replace
const PLATFORM_FEE_SOL = 0.0003; // $0.1 approx
const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"), "confirmed");

let wallet = null;      // wallet object
let publicKey = null;   // wallet public key

// ----- Multi-wallet Connect -----
async function connectWallet() {
  try {
    if(window.solana?.isPhantom) { wallet = window.solana; await wallet.connect(); publicKey = wallet.publicKey; return publicKey; }
    if(window.solflare?.isSolflare) { wallet = window.solflare; await wallet.connect(); publicKey = wallet.publicKey; return publicKey; }
    if(window.glow?.isGlow) { wallet = window.glow; await wallet.connect(); publicKey = wallet.publicKey; return publicKey; }
    if(window.slope?.isSlope) { wallet = window.slope; await wallet.connect(); publicKey = wallet.publicKey; return publicKey; }
    if(window.sollet?.isSollet) { wallet = window.sollet; await wallet.connect(); publicKey = wallet.publicKey; return publicKey; }

    alert("No supported wallet found! Install Phantom, Solflare, Glow, Slope, or Sollet.");
  } catch(err) {
    console.error(err);
    alert("Wallet connection failed!");
  }
}

// ----- URL Params -----
function getParams() {
  const url = new URL(window.location.href);
  const params = url.hash.substring(1);
  const data = {};
  params.split("&").forEach(p=>{
    const [k,v] = p.split("=");
    if(k && v) data[k] = decodeURIComponent(v);
  });
  return data;
}

// ----- Send Transaction (works for all wallets) -----
async function sendTransaction(tx) {
  if(!wallet) return alert("Connect wallet first!");

  try {
    if(wallet.isPhantom || wallet.isSolflare || wallet.isGlow || wallet.isSlope) {
      const { signature } = await wallet.signAndSendTransaction(tx);
      return signature;
    }
    if(wallet.isSollet) {
      await wallet.signTransaction(tx);
      const signature = await wallet.sendTransaction(tx, connection);
      return signature;
    }
  } catch(err) {
    console.error(err);
    alert("Transaction failed!");
  }
}

// ----- Creator Page -----
function creatorPage() {
  app.innerHTML = `
    <h2>Create Sipps Profile</h2>
    <input id="name" placeholder="Display Name (e.g. Jane)" />
    <input id="price" placeholder="Coffee price (SOL)" />
    <button id="connect">Connect Wallet</button>
    <button id="create" disabled>Create Profile</button>
    <p id="link"></p>
  `;

  const connectBtn = document.getElementById("connect");
  const createBtn = document.getElementById("create");
  const linkEl = document.getElementById("link");

  connectBtn.onclick = async () => {
    await connectWallet();
    if(publicKey) {
      createBtn.disabled = false;
      connectBtn.textContent = "Wallet Connected ✅";
    }
  };

  createBtn.onclick = () => {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    if(!name || !price) return alert("Fill all fields");

    const link = `${window.location.origin}/#to=${publicKey}&name=${encodeURIComponent(name)}&price=${price}`;
    linkEl.innerHTML = `Share your link:<br><a href="${link}">${link}</a>`;
    alert("Profile created! Copy the link above.");
  };
}

// ----- Supporter Page -----
async function supporterPage(params) {
  app.innerHTML = `
    <h2>Support ${params.name || "Creator"}</h2>
    <p>Price: ${params.price} SOL</p>
    <button id="pay">Buy Coffee ☕</button>
  `;

  document.getElementById("pay").onclick = async () => {
    await connectWallet();
    if(!wallet) return;

    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: publicKey,
        toPubkey: new solanaWeb3.PublicKey(params.to),
        lamports: parseFloat(params.price) * solanaWeb3.LAMPORTS_PER_SOL
      }),
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: publicKey,
        toPubkey: new solanaWeb3.PublicKey(PLATFORM_WALLET),
        lamports: PLATFORM_FEE_SOL * solanaWeb3.LAMPORTS_PER_SOL
      })
    );

    const signature = await sendTransaction(tx);
    if(signature) alert("☕ Payment sent! Tx: " + signature);
  };
}

// ----- Router -----
const params = getParams();
if(params.to) supporterPage(params);
else creatorPage();

</script>
</body>
</html>