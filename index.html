<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sipps - Support Creators</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
<style>
body { font-family:sans-serif; background:#fff7ed; display:flex; justify-content:center; align-items:center; min-height:100vh; }
.box { background:white; padding:2rem; border-radius:16px; width:360px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
input, button { width:100%; padding:.7rem; margin:.4rem 0; border-radius:8px; border:1px solid #ccc; }
button { background:#ff6b6b; color:white; border:none; cursor:pointer; }
button:hover { background:#ff3b3b; }
button:disabled { background:#ccc; cursor:not-allowed; }
</style>
</head>
<body>

<div class="box" id="app">Loading...</div>

<script>
const app = document.getElementById("app");
const PLATFORM_WALLET = "YOUR_PLATFORM_WALLET_PUBLIC_KEY_HERE"; // replace with your wallet
const PLATFORM_FEE_SOL = 0.0003; // adjust ~ $0.1 in SOL

let wallet = null;

// ----- Helpers -----
async function connectWallet() {
  if(!window.solana) return alert("Install Phantom wallet!");
  try {
    const res = await window.solana.connect();
    wallet = res.publicKey;
    return wallet;
  } catch(err) { console.error(err); alert("Wallet connection failed"); }
}

function getParams() {
  const url = new URL(window.location.href);
  const params = url.hash.substring(1); // remove #
  const data = {};
  params.split("&").forEach(p=>{
    const [k,v] = p.split("=");
    if(k && v) data[k] = decodeURIComponent(v);
  });
  return data;
}

// ----- Creator Page -----
function creatorPage() {
  app.innerHTML = `
    <h2>Create Sipps Profile</h2>
    <input id="name" placeholder="Display Name (e.g. Jane)" />
    <input id="price" placeholder="Coffee price (SOL)" />
    <button id="connect">Connect Wallet</button>
    <button id="create" disabled>Create Profile</button>
    <p id="link" style="word-break:break-all;"></p>
  `;
  
  const connectBtn = document.getElementById("connect");
  const createBtn = document.getElementById("create");
  const linkEl = document.getElementById("link");
  
  connectBtn.onclick = async () => {
    await connectWallet();
    if(wallet) createBtn.disabled = false;
    connectBtn.textContent = "Wallet Connected";
  };
  
  createBtn.onclick = () => {
    const name = document.getElementById("name").value.trim();
    const price = parseFloat(document.getElementById("price").value);
    if(!name || !price) return alert("Fill all fields");
    
    const link = `${window.location.origin}/#to=${wallet}&name=${encodeURIComponent(name)}&price=${price}`;
    linkEl.textContent = `Share this link: ${link}`;
    alert("Profile created! Copy the link above to share.");
  };
}

// ----- Supporter Page -----
async function supporterPage(params) {
  app.innerHTML = `
    <h2>Support ${params.name || "Creator"}</h2>
    <p>Price: ${params.price} SOL</p>
    <button id="pay">Buy Coffee</button>
  `;
  
  document.getElementById("pay").onclick = async () => {
    await connectWallet();
    if(!wallet) return;
    
    const transaction = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet,
        toPubkey: new solanaWeb3.PublicKey(params.to),
        lamports: parseFloat(params.price) * solanaWeb3.LAMPORTS_PER_SOL
      }),
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet,
        toPubkey: new solanaWeb3.PublicKey(PLATFORM_WALLET),
        lamports: PLATFORM_FEE_SOL * solanaWeb3.LAMPORTS_PER_SOL
      })
    );
    
    try {
      const { signature } = await window.solana.signAndSendTransaction(transaction);
      alert("â˜• Payment sent! Tx: " + signature);
    } catch(err) {
      console.error(err);
      alert("Transaction failed");
    }
  };
}

// ----- Router -----
const params = getParams();
if(params.to) supporterPage(params);
else creatorPage();

</script>
</body>
</html>